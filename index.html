<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google-Inspired White & Green Header - Nested Dropdown Fix</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Modern White & Green Design Variables - Refined */
    :root {
      --primary-green: #34A853; /* A vibrant, modern Google-inspired green */
      --light-green: #e6f4ea; /* Very light green for subtle accents/hovers */
      --dark-green: #2F8D46; /* Darker green for active states */
      --white: #ffffff;
      --off-white: #f5f5f5; /* A very subtle off-white for body background */
      --light-gray: #e0e0e0; /* For subtle borders/dividers */
      --text-color-dark: #202124; /* Google-inspired dark gray text */
      --text-color-light: #5f6368; /* Lighter gray for secondary text */
      --box-shadow-subtle: rgba(0, 0, 0, 0.04); /* Very light shadow */
      --box-shadow-hover: rgba(0, 0, 0, 0.08); /* Slightly more visible on hover */
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      --transition-speed-fast: 0.15s;
      --transition-speed-normal: 0.25s;
      --transition-speed-slow: 0.4s;
    }

    /* Global reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--off-white);
      color: var(--text-color-dark);
      line-height: 1.6;
    }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 10px;
      padding: 8px 16px;
      background-color: var(--primary-green);
      color: var(--white);
      text-decoration: none;
      z-index: 2000;
      border-radius: var(--border-radius-md);
      transition: top var(--transition-speed-normal) ease-in-out;
    }

    .skip-link:focus {
      top: 10px;
    }

    /* Header styles */
    .site-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 2rem; /* Adjusted padding for a cleaner look */
      background-color: var(--white);
      color: var(--text-color-dark);
      box-shadow: 0 2px 4px var(--box-shadow-subtle); /* More subtle shadow */
      border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: box-shadow var(--transition-speed-normal) ease; /* Smooth shadow transition */
    }

    /* Optional: Add a stronger shadow on scroll */
    .site-header.scrolled {
      box-shadow: 0 4px 8px var(--box-shadow-hover);
    }

    /* Logo container */
    #logo-container {
      width: 48px; /* Slightly smaller logo for minimalism */
      height: 48px;
      background-color: transparent; /* Transparent background */
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
      cursor: pointer;
    }

    #logo-container:hover {
      background-color: rgba(0, 0, 0, 0.04); /* Subtle hover effect like Google */
      transform: translateY(-1px); /* Slight lift */
    }

    .logo {
      display: none;
      width: 32px; /* Adjusted logo size */
      height: 32px;
    }

    .logo.active {
      display: block;
    }

    /* SVG Logo Colors - Inspired by Google's use of simple shapes */
    .logo #logo-shape {
      fill: var(--primary-green);
    }

    .logo #logo-inner-circle {
      fill: var(--white);
    }

    /* Hamburger button */
    .hamburger {
      display: none; /* Hidden by default for desktop */
      background: none;
      border: none;
      color: var(--text-color-light); /* Lighter gray for icon */
      font-size: 28px; /* Adjusted size */
      cursor: pointer;
      padding: 6px;
      line-height: 1;
      z-index: 1100;
      transition: transform var(--transition-speed-normal) ease-in-out, color var(--transition-speed-fast) ease, background-color var(--transition-speed-fast) ease;
      border-radius: 50%; /* Circular button */
    }

    .hamburger:hover {
      background-color: rgba(0, 0, 0, 0.04); /* Subtle hover */
      color: var(--text-color-dark); /* Darken color on hover */
    }

    .hamburger.nav-open {
      transform: rotate(90deg);
      color: var(--primary-green);
    }

    .hamburger:focus-visible {
      outline: 2px solid var(--primary-green);
      outline-offset: 2px;
      background-color: var(--light-green); /* Highlight focus */
    }

    /* Navigation styles */
    .nav-wrapper {
      display: flex; /* To align nav links and action button */
      align-items: center;
    }

    .nav-links {
      transition: transform var(--transition-speed-normal) ease-in-out, opacity var(--transition-speed-normal) ease-in-out;
      opacity: 1;
    }

    .nav-links ul {
      list-style: none;
      display: flex;
      align-items: center;
    }

    .nav-links li {
      position: relative;
    }

    .nav-links a {
      color: var(--text-color-dark);
      margin-left: 20px; /* Adjusted spacing */
      text-decoration: none;
      font-weight: 500; /* Lighter weight for main nav items */
      font-size: 15px;
      transition: color var(--transition-speed-fast) ease, background-color var(--transition-speed-fast) ease, transform 0.1s ease; /* Quicker transform */
      display: block;
      padding: 8px 12px; /* Smaller padding for a tighter look */
      border-radius: var(--border-radius-md);
    }

    /* Active link styling */
    .nav-links a.active-link {
      background-color: var(--light-green);
      color: var(--primary-green);
    }

    .nav-links a:not(.active-link):hover,
    .nav-links a:not(.active-link):focus-visible {
      color: var(--text-color-dark); /* Keep dark text */
      background-color: rgba(0, 0, 0, 0.04); /* Subtle gray hover */
      transform: translateY(-1px); /* Slight lift on hover */
    }

    /* Dropdown indicator */
    .dropdown-parent > a {
      position: relative;
      padding-right: 25px; /* Space for indicator */
    }

    .dropdown-parent > a::after {
      content: '';
      position: absolute;
      right: 10px; /* Adjusted position */
      top: 50%;
      width: 0;
      height: 0;
      border-left: 4px transparent solid;
      border-right: 4px transparent solid;
      border-top: 4px var(--text-color-light) solid; /* Smaller, lighter indicator */
      transform: translateY(-50%);
      transition: transform var(--transition-speed-fast) ease-in-out, border-top-color var(--transition-speed-fast) ease;
    }

    .dropdown-parent.dropdown-open > a::after,
    .dropdown-parent > a:hover::after,
    .dropdown-parent > a:focus-visible::after {
      transform: translateY(-50%) rotate(180deg);
      border-top-color: var(--primary-green);
    }

    /* Dropdown styles (top-level and nested) */
    .dropdown,
    .sub-dropdown {
      background-color: var(--white);
      box-shadow: 0 2px 6px var(--box-shadow-hover); /* Lighter shadow */
      opacity: 0;
      visibility: hidden;
      transform: translateY(5px); /* Slide down effect */
      transition: opacity var(--transition-speed-fast) ease-out, visibility var(--transition-speed-fast) ease-out, transform var(--transition-speed-fast) ease-out;
      z-index: 1200;
      border-radius: var(--border-radius-md);
      padding: 8px 0;
      border: 1px solid var(--light-gray); /* Subtle border */
      min-width: 170px; /* Slightly adjusted min-width */
    }

    .dropdown {
      position: absolute;
      top: 100%;
      left: 0;
    }

    .sub-dropdown {
      position: absolute;
      top: 0;
      left: 100%;
      margin-left: 5px; /* Slight offset for sub-dropdowns */
    }

    .dropdown-parent.dropdown-open > .dropdown,
    .dropdown-parent.dropdown-open > .sub-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown li,
    .sub-dropdown li {
      display: block;
    }

    .dropdown a,
    .sub-dropdown a {
      margin-left: 0;
      padding: 10px 18px; /* Adjusted padding */
      font-size: 14px;
      font-weight: 400; /* Regular weight for dropdown items */
      color: var(--text-color-dark);
      border-radius: 0; /* No border-radius for individual dropdown items */
    }

    .dropdown a:hover,
    .sub-dropdown a:hover,
    .dropdown a:focus-visible,
    .sub-dropdown a:focus-visible {
      background-color: var(--light-green);
      color: var(--primary-green);
    }

    /* Action Button (e.g., "Get Started") */
    .action-button {
      margin-left: 24px; /* Space from navigation */
      padding: 10px 20px;
      background-color: var(--primary-green);
      color: var(--white);
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      border-radius: var(--border-radius-md);
      transition: background-color var(--transition-speed-fast) ease, transform 0.1s ease, box-shadow var(--transition-speed-fast) ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: none; /* Ensure no default button border */
      cursor: pointer; /* Indicate it's clickable */
    }

    .action-button:hover {
      background-color: var(--dark-green);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .action-button:focus-visible {
      outline: 2px solid var(--primary-green);
      outline-offset: 2px;
    }


    /* Responsive adjustments */
    @media (max-width: 768px) {
      .site-header {
        padding: 0.7rem 4%;
        border-radius: 0;
        box-shadow: 0 2px 4px var(--box-shadow-subtle); /* Reset shadow for mobile */
      }
      .site-header.scrolled {
        box-shadow: 0 4px 8px var(--box-shadow-hover); /* Keep scroll shadow for mobile too */
      }


      #logo-container {
        width: 44px;
        height: 44px;
      }

      .logo {
        width: 28px;
        height: 28px;
      }

      .hamburger {
        display: block; /* Hamburger should be visible on mobile */
        /* Ensure hamburger remains in its place */
        position: relative; /* If needed for stacking context */
        z-index: 1200; /* Above menu to be clickable */
      }

      /* Mobile Navigation Drawer - Refactored */
      .nav-wrapper {
        position: absolute; /* Position relative to site-header */
        top: 100%; /* Below the header */
        left: 0;
        width: 100%;
        max-height: 0; /* Start hidden */
        background-color: var(--white);
        opacity: 0;
        visibility: hidden; /* Ensure initially hidden */
        z-index: 999;
        border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Consistent shadow */
        overflow-y: hidden; /* Hide overflow initially */
        /* Transitions for max-height, opacity, and visibility */
        transition: max-height var(--transition-speed-slow) ease-in-out,
                    opacity var(--transition-speed-normal) ease-in-out,
                    visibility var(--transition-speed-normal) ease-in-out;
        flex-direction: column; /* Stack children vertically */
        align-items: center; /* Center items */
        padding-bottom: 0; /* No bottom padding when closed */
      }

      .nav-wrapper.nav-open {
        max-height: calc(100vh - 64px); /* Full height minus header height, or generous value */
        opacity: 1;
        visibility: visible;
        overflow-y: auto; /* Allow scrolling for content longer than max-height */
        padding-bottom: 20px; /* Add some padding at the bottom when open */
      }

      .nav-wrapper .nav-links {
        width: 100%; /* Full width within the wrapper */
        margin-bottom: 10px; /* Space between nav and button */
      }

      .nav-links ul {
        flex-direction: column;
        align-items: flex-start; /* Align text left */
        padding: 20px;
        padding-top: 10px; /* Adjust padding */
      }

      .nav-links li {
        width: 100%; /* Full width list items */
      }

      .nav-links a {
        margin: 5px 0; /* Reduced margin for tighter list */
        font-size: 16px;
        width: 100%;
        padding: 12px 15px; /* Larger touch area for mobile */
      }

      /* Mobile: Active link just highlights text, no background */
      .nav-links a.active-link {
        background-color: transparent;
        color: var(--primary-green);
      }

      /* Mobile: Dropdowns - Simplified to just expand within their parent flow */
      .dropdown,
      .sub-dropdown {
        position: static; /* No absolute positioning */
        transform: none;
        background-color: var(--off-white); /* Slightly different background for visual nesting */
        box-shadow: none;
        padding-left: 20px;
        opacity: 0;
        visibility: hidden;
        max-height: 0; /* Start collapsed */
        overflow: hidden;
        transition: max-height var(--transition-speed-slow) ease-in-out,
                    opacity var(--transition-speed-normal) ease-in-out,
                    visibility var(--transition-speed-normal) ease-in-out;
        border-radius: 0;
        border: none;
        width: 100%; /* Important for nested links to fill width */
      }

      .dropdown-parent.dropdown-open > .dropdown,
      .dropdown-parent.dropdown-open > .sub-dropdown {
        visibility: visible;
        opacity: 1;
        max-height: 500px; /* A large enough value to accommodate content */
      }

      .sub-dropdown {
        padding-left: 35px;
      }

      .dropdown-parent > a::after {
        right: 15px;
      }

      /* Action button in mobile menu */
      .action-button {
        display: block;
        width: calc(100% - 40px); /* Adjust width to fit padding */
        margin: 15px auto 0; /* Center it */
        text-align: center;
        padding: 12px 20px;
        box-shadow: none; /* No shadow in mobile menu */
      }
    }

    /* Desktop styles */
    @media (min-width: 769px) {
      #logo-lg {
        display: block;
      }

      #logo-sm {
        display: none;
      }

      .nav-wrapper {
        display: flex; /* Keep wrapper visible and flex for desktop */
        flex-grow: 1; /* Allow it to take available space */
        justify-content: flex-end; /* Push content to the right */
        align-items: center;
      }

      .nav-links {
        transform: none !important;
        opacity: 1 !important;
        max-height: none !important;
        overflow: visible !important;
        flex-grow: 1; /* Allow nav links to grow */
        justify-content: flex-end; /* Push links to the right */
        display: flex; /* Ensure links are aligned */
      }

      .nav-links ul {
        flex-direction: row;
        justify-content: flex-end;
      }

      /* Desktop: Dropdowns open on hover/focus */
      .nav-links .dropdown-parent:hover > .dropdown,
      .nav-links .dropdown-parent:focus-within > .dropdown,
      .nav-links .dropdown-parent:hover > .sub-dropdown,
      .nav-links .dropdown-parent:focus-within > .sub-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
    }

    /* High contrast for accessibility */
    @media (prefers-contrast: high) {
      #logo-container {
        background: var(--primary-green);
      }

      .logo #logo-shape {
        fill: var(--white);
      }

      .logo #logo-inner-circle {
        fill: var(--dark-green);
      }

      .site-header {
        background: #000;
        color: #fff;
        box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
      }

      .hamburger {
        color: #fff;
        border: 1px solid #fff;
      }
      .hamburger:hover {
        background-color: #333;
        color: #fff;
      }

      .nav-links,
      .dropdown,
      .sub-dropdown {
        background: #000 !important;
        border-color: #fff !important;
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3) !important;
      }

      .nav-links a {
        color: #fff;
      }

      .nav-links a:hover,
      .nav-links a:focus-visible {
        color: #000;
        background: var(--primary-green);
      }

      .nav-links a.active-link {
        background-color: var(--primary-green) !important;
        color: #000 !important;
        box-shadow: inset 0 0 0 2px #fff !important;
      }

      .dropdown-parent > a::after {
        border-top-color: #fff !important;
      }
      .dropdown-parent.dropdown-open > a::after,
      .dropdown-parent > a:hover::after,
      .dropdown-parent > a:focus-visible::after {
        border-top-color: var(--primary-green) !important;
      }

      .action-button {
        background-color: #fff;
        color: #000;
        border: 1px solid #fff;
      }
      .action-button:hover {
        background-color: var(--primary-green);
        color: #fff;
      }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to content</a>
  <header class="site-header">
    <div id="logo-container">
      <svg id="logo-lg" class="logo active" viewBox="0 0 100 100" aria-label="Desktop logo">
        <path id="logo-shape" d="M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z" />
        <circle id="logo-inner-circle" cx="50" cy="50" r="25" />
      </svg>
      <svg id="logo-sm" class="logo" viewBox="0 0 100 100" aria-label="Mobile logo">
        <circle id="logo-shape" cx="50" cy="50" r="40" />
        <path id="logo-inner-circle" d="M30 50 L45 65 L70 35 L70 50 L45 75 L30 60 Z" />
      </svg>
    </div>
    <button class="hamburger" aria-expanded="false" aria-controls="nav-links" aria-label="Toggle navigation menu">☰</button>

    <div class="nav-wrapper">
        <nav id="nav-links" class="nav-links" aria-label="Main navigation">
            <ul>
                <li><a href="/" aria-current="page">Home</a></li>
                <li class="dropdown-parent">
                    <a href="/about" aria-haspopup="true" aria-expanded="false" aria-label="About menu">About</a>
                    <ul class="dropdown">
                        <li><a href="/about/team">Our Team</a></li>
                        <li><a href="/about/history">Our Story</a></li>
                        <li><a href="/about/mission">Our Mission</a></li>
                    </ul>
                </li>
                <li class="dropdown-parent">
                    <a href="/services" aria-haspopup="true" aria-expanded="false" aria-label="Services menu">Services</a>
                    <ul class="dropdown">
                        <li class="dropdown-parent">
                            <a href="/services/consulting" aria-haspopup="true" aria-expanded="false" aria-label="Consulting services submenu">Consulting</a>
                            <ul class="dropdown sub-dropdown">
                                <li><a href="/services/consulting/strategy">Strategy</a></li>
                                <li><a href="/services/consulting/operations">Operations</a></li>
                                <li><a href="/services/consulting/digital">Digital</a></li>
                            </ul>
                        </li>
                        <li><a href="/services/development">Development</a></li>
                        <li><a href="/services/marketing">Marketing</a></li>
                    </ul>
                </li>
                <li><a href="/portfolio">Portfolio</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="/contact">Contact</a></li>
            </ul>
        </nav>
        <button class="action-button">Get Started</button>
    </div>
  </header>
  <main id="main-content">
    <p style="height: 1200px; padding: 20px;">Main content goes here. Scroll down to see the sticky header in action!</p>
  </main>
  <script>
    // --- Element Selectors ---
    const siteHeader = document.querySelector('.site-header');
    const logoLg = document.getElementById('logo-lg');
    const logoSm = document.getElementById('logo-sm');
    const hamburger = document.querySelector('.hamburger');
    const navLinks = document.getElementById('nav-links');
    const navWrapper = document.querySelector('.nav-wrapper'); // Select the nav wrapper
    const dropdownToggles = document.querySelectorAll('.dropdown-parent > a[aria-haspopup="true"]');
    const allNavLinks = navLinks ? navLinks.querySelectorAll('a') : [];

    // --- Utility Functions ---

    /**
     * Debounces a function call.
     * @param {function} func The function to debounce.
     * @param {number} wait The debounce time in milliseconds.
     * @returns {function} The debounced function.
     */
    function debounce(func, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    /**
     * Checks if the current screen width is mobile.
     * @returns {boolean} True if mobile, false otherwise.
     */
    function isMobileView() {
      return window.matchMedia('(max-width: 768px)').matches;
    }

    // --- Core Header Functionality ---

    /**
     * Updates the active logo (desktop vs. mobile) based on screen width.
     */
    function updateLogo() {
      if (!logoLg || !logoSm) return;
      const isDesktop = !isMobileView();
      logoLg.classList.toggle('active', isDesktop);
      logoSm.classList.toggle('active', !isDesktop);
    }

    /**
     * Sets the 'active-link' class on the current page's navigation item.
     */
    function setActiveLink() {
      const path = window.location.pathname;
      allNavLinks.forEach(link => {
        link.classList.remove('active-link');
        link.removeAttribute('aria-current');

        if (link.pathname === path || (link.pathname === "/" && path === "/")) {
          link.classList.add('active-link');
          link.setAttribute('aria-current', 'page');
        }
      });
    }

    /**
     * Toggles the mobile navigation menu's open/closed state.
     */
    function toggleMenu() {
      if (!hamburger || !navWrapper) return;

      const isExpanded = hamburger.getAttribute('aria-expanded') === 'true';
      hamburger.setAttribute('aria-expanded', !isExpanded);
      hamburger.classList.toggle('nav-open');
      hamburger.textContent = isExpanded ? '☰' : '✕';

      navWrapper.classList.toggle('nav-open', !isExpanded);

      if (isExpanded) { // If closing the main menu
        closeAllDropdowns(); // Close all open dropdowns within it
      }

      if (!isExpanded && isMobileView()) {
        trapFocus();
      }
    }

    /**
     * Toggles the open/closed state of a dropdown menu.
     * @param {Event} event The click event.
     */
    function toggleDropdown(event) {
      const toggle = event.currentTarget;
      const parent = toggle.parentElement; // The <li>.dropdown-parent for the current toggle
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';

      // First, close all other dropdowns that are not ancestors of the current clicked dropdown.
      dropdownToggles.forEach(otherToggle => {
        if (otherToggle !== toggle) { // Don't process the current toggle yet
          const otherParent = otherToggle.parentElement; // The <li>.dropdown-parent for the other toggle

          // Check if the other dropdown is open
          if (otherParent.classList.contains('dropdown-open')) {
            // Check if the 'otherToggle' (e.g., Services) is NOT an ancestor of the current 'toggle' (e.g., Consulting)
            // If `parent.contains(otherToggle)` is true, it means `otherToggle` is an ancestor of `toggle`,
            // so we should NOT close it. We only close if `otherToggle` is a sibling or an unrelated dropdown.
            if (!parent.contains(otherToggle)) {
              otherToggle.setAttribute('aria-expanded', 'false');
              otherParent.classList.remove('dropdown-open');
            }
          }
        }
      });

      // Now, toggle the current dropdown
      toggle.setAttribute('aria-expanded', !isExpanded);
      parent.classList.toggle('dropdown-open');

      if (isMobileView()) {
        event.preventDefault(); // Prevent navigation on mobile for dropdown toggles
      }
      event.stopPropagation(); // Stop propagation to prevent document click from closing immediately
    }


    /**
     * Closes all currently open dropdown menus.
     */
    function closeAllDropdowns() {
      dropdownToggles.forEach(toggle => {
        toggle.setAttribute('aria-expanded', 'false');
        toggle.parentElement.classList.remove('dropdown-open');
      });
    }

    /**
     * Handles clicks outside the navigation menu to close it.
     * Applies to both main mobile menu and desktop dropdowns.
     * @param {Event} event The click event.
     */
    function handleOutsideClick(event) {
      // Close main mobile menu if open and click is outside
      if (isMobileView() && hamburger && hamburger.getAttribute('aria-expanded') === 'true' &&
          !navWrapper.contains(event.target) && !hamburger.contains(event.target)) {
        toggleMenu();
        return;
      }

      // Close any open dropdowns if click is outside all open dropdowns
      let clickedInsideOpenDropdown = false;
      dropdownToggles.forEach(toggle => {
          if (toggle.getAttribute('aria-expanded') === 'true' && toggle.parentElement.contains(event.target)) {
              clickedInsideOpenDropdown = true;
          }
      });
      // Also ensure click isn't on the hamburger itself (which might be a dropdown toggle on desktop if menu is hidden)
      if (!clickedInsideOpenDropdown && !hamburger.contains(event.target)) {
          closeAllDropdowns();
      }
    }


    /**
     * Traps focus within the mobile menu when it's open for accessibility.
     */
    function trapFocus() {
      if (!navWrapper || !hamburger || !isMobileView()) return;

      const focusableElements = navWrapper.querySelectorAll('a, button');
      const firstFocusable = focusableElements.length > 0 ? focusableElements[0] : null;
      const lastFocusable = focusableElements.length > 0 ? focusableElements[focusableElements.length - 1] : null;

      if (!firstFocusable || !lastFocusable) return;

      setTimeout(() => {
          if (document.activeElement !== firstFocusable && document.activeElement !== hamburger) {
              firstFocusable.focus();
          }
      }, 50);

      navWrapper.removeEventListener('keydown', handleTrapFocusKeydown);
      navWrapper.addEventListener('keydown', handleTrapFocusKeydown);
    }

    /**
     * Keydown handler for trapFocus.
     * @param {Event} event The keydown event.
     */
    function handleTrapFocusKeydown(event) {
        if (!isMobileView() || hamburger.getAttribute('aria-expanded') !== 'true') return;
        if (event.key === 'Tab') {
            const focusableElements = navWrapper.querySelectorAll('a, button');
            const firstFocusable = focusableElements.length > 0 ? focusableElements[0] : null;
            const lastFocusable = focusableElements.length > 0 ? focusableElements[focusableElements.length - 1] : null;

            if (!firstFocusable || !lastFocusable) return;

            if (event.shiftKey) {
                if (document.activeElement === firstFocusable) {
                    event.preventDefault();
                    lastFocusable.focus();
                }
            } else {
                if (document.activeElement === lastFocusable) {
                    event.preventDefault();
                    firstFocusable.focus();
                }
            }
        }
    }

    /**
     * Handles global keydown events for accessibility (e.g., Escape key).
     * @param {Event} event The keydown event.
     */
    function handleGlobalKeyDown(event) {
      if (event.key === 'Escape') {
        if (hamburger && hamburger.getAttribute('aria-expanded') === 'true') {
          toggleMenu();
          hamburger.focus();
        }
        closeAllDropdowns();
      }
    }

    /**
     * Adds a shadow to the header when scrolled.
     */
    function handleScrollShadow() {
        if (window.scrollY > 0) {
            siteHeader.classList.add('scrolled');
        } else {
            siteHeader.classList.remove('scrolled');
        }
    }

    // --- Initialization and Event Listeners ---

    document.addEventListener('DOMContentLoaded', () => {
      closeAllDropdowns();
      setActiveLink();
      updateLogo();
      handleScrollShadow();
    });

    const debouncedUpdateLogo = debounce(updateLogo, 100);
    window.addEventListener('resize', () => {
      debouncedUpdateLogo();
      if (navWrapper) {
          if (!isMobileView()) {
              navWrapper.classList.remove('nav-open');
              hamburger.setAttribute('aria-expanded', 'false');
              hamburger.classList.remove('nav-open');
              hamburger.textContent = '☰';
              closeAllDropdowns();
          }
      }
    });

    const mediaQuery = window.matchMedia('(min-width: 769px)');
    mediaQuery.addEventListener('change', updateLogo);

    if (hamburger) {
      hamburger.addEventListener('click', toggleMenu);
    }

    if (dropdownToggles) {
      dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', toggleDropdown);
      });
    }

    if (navWrapper) {
      const menuLinksToCloseMenu = navWrapper.querySelectorAll('a:not([aria-haspopup="true"])');
      menuLinksToCloseMenu.forEach(link => {
        link.addEventListener('click', () => {
          if (isMobileView() && hamburger.getAttribute('aria-expanded') === 'true') {
            toggleMenu();
          }
        });
      });
    }


    document.addEventListener('click', handleOutsideClick);
    document.addEventListener('keydown', handleGlobalKeyDown);
    window.addEventListener('scroll', debounce(handleScrollShadow, 50));
  </script>
</body>
</html>